@page "/Profile"
@attribute [Authorize]
@inject IConversationData conversationData
@inject IUserData userData
@inject IFriendRequestData requestData
@inject NavigationManager navManager
@inject AuthenticationStateProvider authProvider

<h1 class="text-center text-uppercase fw-bold mb-4">My Profile</h1>

<div class="rounded rounded-3 shadow">
  <div class="card-body">
    <div class="row justify-content-center">
      <div class="col-lg-10 col-md-8 card bg-dark p-4">
        <div class="row">
          <div class="col-11">
            <div>
              <h2>My Account</h2>
              <p>You are logged as: @loggedInUser?.DisplayName</p>
              <p>Your actual name is: @loggedInUser?.FullName</p>
              <p>You joined Chatify on @loggedInUser?.DateCreated.ToString("dd/MM/yyyy")</p>
              <button class="btn btn-outline-warning w-100" @onclick="EditProfilePage">Edit My Profile</button>
            </div>
            <hr />
            @if (loggedInUser?.Friends.Count > 0)
            {
                <div>
                  <h2>Your Friends</h2>
                  @foreach (var f in loggedInUser.Friends)
                  {
                    <div class="clickable" @onclick="(() => OpenDetailsFriend(f))">
                      <div class="fw-bold">
                        @f.DisplayName
                      </div>
                      <div>
                        This user has joined Chatify on @f.DateCreated.ToString("dd/MM/yyyy")
                      </div>
                    </div>
                  }
                </div>
            }
            <hr />
            @if (conversations?.Count > 0)
            {
                <h2 class="card-title mt-4">Your Conversations</h2>
                @foreach (var c in conversations)
                {
                    <div class="card card-body create-form-layout bg-black clickable" @onclick="(() => OpenDetailsConversation(c))">
                        <div class="card-body">
                            <div class="card-text mb-3">
                            <div class="fw-bold">@c.GroupName</div>
                            <div>@c.Participants.Count Participants</div>
                            <div>@c.DateCreated.ToString("dd/MM/yyyy")</div>
                            </div>
                        </div>
                    </div>
                }
            }
          </div>
          <div class="col-1">
            <div class="close-button-section">
              <button class="btn btn-close btn-close-white" @onclick="ClosePage"/>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

@code {
    private UserModel loggedInUser;
    private List<ConversationModel> conversations;

    protected override async Task OnInitializedAsync()
    {
        loggedInUser = await authProvider.GetUserFromAuth(userData);
        if (loggedInUser is not null)
        {
            conversations = await conversationData.GetUserConversationsAsync(loggedInUser.Id);
        }
    }

    private void ClosePage()
    {
        navManager.NavigateTo("/");
    }

    private void OpenDetailsFriend(BasicUserModel user)
    {
        navManager.NavigateTo($"/UserDetails/{user.Id}");
    }

    private void OpenDetailsConversation(ConversationModel conversation)
    {
        navManager.NavigateTo($"/conversation/{conversation.Id}");
    }

    private void EditProfilePage()
    {
        navManager.NavigateTo("/MicrosoftIdentity/Account/EditProfile", true);
    }
}
